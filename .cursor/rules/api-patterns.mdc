---
description:
globs:
alwaysApply: true
---
# API Communication Patterns

## Tempo AI API Integration

This project communicates with the Tempo AI API using consistent patterns defined in [src/tempoai_mcp_server/api/client.py](mdc:src/tempoai_mcp_server/api/client.py).

## Core API Function

All API communication goes through `make_tempo_ai_request()`:

```python
async def make_tempo_ai_request(
    url: str,
    api_key: str | None = None,
    params: dict[str, Any] | None = None
) -> dict[str, Any] | list[dict[str, Any]]
```

### Usage Pattern
- **URL Format**: Relative paths like `/mcp/workouts`, `/mcp/events`, `/mcp/wellness`
- **Authentication**: Bearer token authentication using `Authorization: Bearer {api_key}` header
- **Headers**: Includes User-Agent and Accept: application/json
- **Timeout**: 30 seconds for all requests

## Error Handling Strategy

### HTTP Status Code Mapping
The system provides user-friendly messages for common HTTP errors:
- `401 Unauthorized` - Invalid API key
- `403 Forbidden` - Permission denied
- `404 Not Found` - Resource doesn't exist
- `422 Unprocessable Entity` - Invalid parameters
- `429 Too Many Requests` - Rate limiting
- `500 Internal Server Error` - Server issues
- `503 Service Unavailable` - Maintenance/downtime

### Error Response Format
All errors return a consistent structure:
```python
{
    "error": True,
    "status_code": int,  # HTTP status code
    "message": str       # User-friendly error message
}
```

## MCP Tool Implementation Pattern

1. **Parameter Validation**: Check required parameters and provide defaults
2. **API Key Resolution**: Use provided key or fall back to global `API_KEY`
3. **Date Validation**: Parse and validate date strings
4. **API Request**: Call `make_tempo_ai_request()` with appropriate parameters
5. **Error Checking**: Return formatted error messages for API failures
6. **Data Formatting**: Use utilities from [src/tempoai_mcp_server/utils/formatting.py](mdc:src/tempoai_mcp_server/utils/formatting.py)

## Environment Variables

Required configuration (validated on startup):
- `API_KEY` - Cannot be empty

Optional configuration:
- `TEMPO_AI_API_BASE_URL` - Defaults to `https://api.jointempo.ai/v1`

## Shared HTTP Client

Uses a single `httpx.AsyncClient` instance (`httpx_client`) managed by the FastMCP lifespan context manager to:
- Reuse connections for better performance
- Ensure proper cleanup when server stops
